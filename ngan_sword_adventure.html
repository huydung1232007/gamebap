<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Chi·∫øn Binh Xuy√™n 5 M√†n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #111;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: sans-serif;
      color: #fff;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
    }

    canvas {
      width: 100vw;
      height: 100vh;
      display: block;
    }

    #ui {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      font-size: 18px;
      z-index: 5;
      white-space: nowrap;
    }

    #touchControls {
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
      z-index: 10;
    }

    #touchControls button {
      width: 72px;
      height: 72px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      font-size: 32px;
      font-weight: bold;
      backdrop-filter: blur(4px);
    }

    /* ·∫®n c√°c n√∫t ƒëi·ªÅu khi·ªÉn c·∫£m ·ª©ng tr√™n thi·∫øt b·ªã c√≥ hover (desktop) */
    @media (hover: hover) and (pointer: fine) {
      #touchControls { display: none; }
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="ui"><span id="levelLabel">M√†n 1 / 5</span> | HP: <span id="hpLabel">3</span></div>

  <!-- Touch controls for mobile -->
  <div id="touchControls">
    <button id="btnLeft">‚Üê</button>
    <button id="btnAttack">‚öî</button>
    <button id="btnRight">‚Üí</button>
  </div>

  <script>
    /************** CANVAS SETUP **************/
    const canvas = document.getElementById('game');
    const ctx    = canvas.getContext('2d');

    // H·ªó tr·ª£ hi·ªÉn th·ªã n√©t cƒÉng tr√™n m√†n h√¨nh Retina
    function resize() {
      const dpr = window.devicePixelRatio || 1;
      canvas.width  = window.innerWidth  * dpr;
      canvas.height = window.innerHeight * dpr;
      ctx.scale(dpr, dpr);
    }
    window.addEventListener('resize', resize);
    resize();

    /************** INPUT **************/
    const input = { left: false, right: false, attackOnce: false };

    // Keyboard controls
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft')  input.left  = true;
      if (e.key === 'ArrowRight') input.right = true;
      if (e.key === ' ' || e.key === 'Spacebar') input.attackOnce = true;
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowLeft')  input.left  = false;
      if (e.key === 'ArrowRight') input.right = false;
    });

    // Touch controls
    const btnLeft   = document.getElementById('btnLeft');
    const btnRight  = document.getElementById('btnRight');
    const btnAttack = document.getElementById('btnAttack');

    function addTouch(btn, key) {
      btn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (key === 'attack') input.attackOnce = true;
        else input[key] = true;
      }, { passive: false });
      btn.addEventListener('touchend', (e) => {
        e.preventDefault();
        if (key !== 'attack') input[key] = false;
      }, { passive: false });
    }
    addTouch(btnLeft,   'left');
    addTouch(btnRight,  'right');
    addTouch(btnAttack, 'attack');

    /************** ASSETS **************/
    const warriorImg = new Image();
    warriorImg.src = 'https://archive.org/download/bb_20250607_202506/bb.png'; // ƒê·∫∑t file ·∫£nh nh√¢n v·∫≠t chung th∆∞ m·ª•c & ƒë√∫ng t√™n
    let warriorReady = false;
    warriorImg.onload = () => warriorReady = true;

    /************** GAME OBJECTS **************/
    class Warrior {
      constructor() {
        this.w = 80;
        this.h = 120;
        this.x = (canvas.width / window.devicePixelRatio - this.w) / 2;
        this.y = window.innerHeight - this.h - 30;
        this.speed = 6;
        this.hpMax = 3;
        this.hp = this.hpMax;
        this.fireCooldown = 0;
        this.name = 'Ng√¥ Th√πy Ng√¢n';
      }
      update() {
        if (input.left)  this.x -= this.speed;
        if (input.right) this.x += this.speed;
        // Gi·ªõi h·∫°n trong m√†n h√¨nh
        this.x = Math.max(0, Math.min(window.innerWidth - this.w, this.x));
        if (this.fireCooldown > 0) this.fireCooldown--;
      }
      canShoot() { return this.fireCooldown === 0; }
      shoot() {
        this.fireCooldown = 15; // ~4 ph√°t/gi√¢y ·ªü 60fps
        lasers.push(new Laser(this.x + this.w / 2 - 3, this.y - 10));
      }
      draw() {
        // Sprite
        if (warriorReady) ctx.drawImage(warriorImg, this.x, this.y, this.w, this.h);
        else {
          ctx.fillStyle = '#fff';
          ctx.fillRect(this.x, this.y, this.w, this.h);
        }
        // Name
        ctx.font = '18px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#fff';
        ctx.fillText(this.name, this.x + this.w / 2, this.y - 24);
        // Health bar
        const barW = this.w;
        const barH = 6;
        const barX = this.x;
        const barY = this.y - 14;
        ctx.fillStyle = '#555';
        ctx.fillRect(barX, barY, barW, barH);
        ctx.fillStyle = '#0f0';
        ctx.fillRect(barX, barY, barW * (this.hp / this.hpMax), barH);
      }
      get rect() { return { x: this.x, y: this.y, w: this.w, h: this.h }; }
    }

    class Laser {
      constructor(x, y) {
        this.x = x;
        this.y = y;
        this.w = 6;
        this.h = 20;
        this.speed = 12;
      }
      update() { this.y -= this.speed; }
      offScreen() { return this.y + this.h < 0; }
      draw() {
        ctx.fillStyle = '#0ff';
        ctx.fillRect(this.x, this.y, this.w, this.h);
      }
      get rect() { return { x: this.x, y: this.y, w: this.w, h: this.h }; }
    }

    class Monster {
      constructor(level) {
        this.w = 80;
        this.h = 80;
        this.x = Math.random() * (window.innerWidth - this.w);
        this.y = 100 + Math.random() * 150;
        this.baseSpeed = 2 + level * 0.4;
        this.dx = this.baseSpeed;
        this.hp = 1 + level;
      }
      update() {
        this.x += this.dx;
        // ƒê·ªïi h∆∞·ªõng khi ch·∫°m m√©p
        if (this.x <= 0 || this.x + this.w >= window.innerWidth) {
          this.dx *= -1;
          this.y += 10; // Ti·∫øn xu·ªëng g·∫ßn ng∆∞·ªùi ch∆°i h∆°n
        }
      }
      draw() {
        ctx.fillStyle = '#c33';
        ctx.fillRect(this.x, this.y, this.w, this.h);
      }
      get rect() { return { x: this.x, y: this.y, w: this.w, h: this.h }; }
    }

    /************** COLLISION **************/
    function rectsIntersect(a, b) {
      return !(a.x + a.w < b.x || b.x + b.w < a.x || a.y + a.h < b.y || b.y + b.h < a.y);
    }

    /************** GAME STATE **************/
    let warrior = new Warrior();
    let level    = 1;
    let monsters = [new Monster(level)];
    const lasers = [];
    const maxLevel = 5;

    function nextLevel() {
      level++;
      if (level > maxLevel) {
        alert('B·∫°n ƒë√£ chi·∫øn th·∫Øng t·∫•t c·∫£ qu√°i v·∫≠t!');
        window.location.reload();
        return;
      }
      document.getElementById('levelLabel').textContent = `M√†n ${level} / ${maxLevel}`;
      monsters = [new Monster(level)];
    }

    /************** MAIN LOOP **************/
    function loop() {
      requestAnimationFrame(loop);

      ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);

      // Update
      warrior.update();
      if (input.attackOnce && warrior.canShoot()) warrior.shoot();
      input.attackOnce = false; // Reset single-fire flag

      lasers.forEach((l, i) => {
        l.update();
        if (l.offScreen()) lasers.splice(i, 1);
      });

      monsters.forEach(m => m.update());

      // Collisions: Laser ‚Üî Monster
      for (let li = lasers.length - 1; li >= 0; li--) {
        for (let mi = monsters.length - 1; mi >= 0; mi--) {
          if (rectsIntersect(lasers[li].rect, monsters[mi].rect)) {
            monsters[mi].hp--;
            lasers.splice(li, 1);
            if (monsters[mi].hp <= 0) monsters.splice(mi, 1);
            break;
          }
        }
      }

      // Collisions: Monster ‚Üî Warrior
      monsters.forEach(m => {
        if (rectsIntersect(m.rect, warrior.rect)) {
          if (warrior.hp > 0) {
            warrior.hp--;
            document.getElementById('hpLabel').textContent = warrior.hp;
          }
          m.x += m.dx * 10; // ƒê·∫©y qu√°i ra nh·∫π
          if (warrior.hp <= 0) {
            alert('B·∫°n ƒë√£ b·ªã ƒë√°nh b·∫°i!');
            window.location.reload();
          }
        }
      });

      // Level cleared?
      if (monsters.length === 0) nextLevel();

      // Draw
      warrior.draw();
      lasers.forEach(l => l.draw());
      monsters.forEach(m => m.draw());
    }

    // üî• B·∫Øt ƒë·∫ßu game!
    loop();
  </script>
</body>
</html>
